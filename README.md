# Convex Platform

Goals
-----
- Community based staking with boosting without the need for locking yourself.
- Smart contract wallet users can participate in the curve boost ecosystem.
- Receive rewards in crv(and incentive tokens if there are any), not underlying lp tokens.
- People who fund the boost by depositing crv get a % of crv rewards as a reward (plus vecrv fee claims).
- No management/strategies, just staking on curve.
- Key management risk has been mitigated.  Most vault platforms have multisig keys that could potential cause user harm.  Remove need for trust by not including any keys that have abilities to change/deploy contracts.


LP Users
----
- Deposit lp tokens to the booster system, it will stake in curve's gauge system for you.
- Gain CRV rewards, as well as extra incentive tokens (ex. SNX)
- Rewards are periodically claimed from the gauge and moved to a synthetix inspired reward contract, with rewards tail emission of seven days.
- Receive this system's native token(CVX) as a reward. (Liquidity Mining).

Crv Stakers
----
- Deposit CRV to the system.  This CRV is locked forever. Receive cCrv token.
- Deposit cCrv in a reward contract. (can be withdrawn whenever)
- Receive a portion of the fees generated by the system. (in CRV)
- A % of CRV generated by LP users is distributed to owners. (currently 10%)
- All normal veCrv rewards are also distributed.

CVX Stakers
---
- Deposit CVX on the system. (can be withdrawn whenever)
- Receive a portion of the fees generated by the system. (in cCrv)

Harvesters
----
- The system requires that someone periodically claims crv and other rewards from the Curve platform.
- These calls can be triggered by anyone.
- A % of CRV claimed on behalf of LP users will be given back to the caller as an incentive to keep the system going and compensation for gas. (currently 0.5%)
- An incentive is also in place to lock deposited crv for vecrv.


Tokenomics
-------
- cCrv (Tokenized veCrv)
	- Tokenized deposits, minted 1:1 for each crv locked in the system.
	- Stake in reward contract to receive platform fees. (CRV)

- Convex (CVX)
	- Max Supply: 10 million
	- Distribution: 
		- 50% Curve LP rewards
		- 15% cCrv/Crv LP rewards
		- 15% CVX/ETH LP rewards
		- 5% Treasury for future incentives
		- 5% VeCrv holders
		- 10% Team
	- Distribution Timeframe
		- Curve Staking: Rewarded at a determined ratio to CRV generated on the platform
		- cCrv/Crv LPs: each block over 4 years (3.75% per year)
		- CVX/ETH LPs: each block over 4 years (3.75% per year)
		- Treasury: each block over 1 year
		- Vecrv: each block over 1 year
		- Team: each block over 1 year
	- Treasury will be held by multisig. reward for community driven activities. could be burnt too if so desired.
	- Farming rewards are minted for each CRV claimed at a determined ratio.
	- Mint ratio decreases as total supply increases.
	- Stake in reward contract to receive platform fees. (cCrv)


Contract Components
----
- Booster
	- Main deposit contract
	- Keep track of pool info
	- Keep track of user deposits
	- Distributes rewards

- Voter Proxy
	- Whitelisted contract
	- Locks crv for veCrv
	- Holds and stakes all lp tokens
	- Directly interacts with all Curve related functions

- Stash
	- Handles extra rewards
	- Temporarily sweeps and holds extra rewards that were distributed on deposit and withdraw
	- Creates reward contracts for extra incentive tokens and distributes to users
	- Pools with no reward functionality do not need a stash
	- Curve gauges v1 and v2 need different type of stashes to handle api changes

- BaseRewardPool
	- Modified synthetix reward contract for staking for rewards
	- Edits
		- queueing of new rewards that are mined throughout the epohc
		- list of child reward pools to link together
		- notify Booster contract when claims are made (to mint cvx)
		- allow withdrawing directly to main booster contract so that it can exit your position in one transaction.

- cvxRewardPool
	- Modified synthetix reward contract for staking for rewards
	- Edits
		- queueing of new rewards that are mined throughout the epohc
		- list of child reward pools to link together
		- upon withdrawing, automatically deposit into crvdepositor

- VirtualBalanceRewardPool
	- Linked to base reward pools
	- Balance is pulled from linked reward pool
	- Claiming rewards from base pool will claim from virtual pools as well

- StashFactory
	- Create stashes on the fly when new pools are added

- RewardFactory
	- Create reward contracts on the fly when new pools are added
	- Create reward contracts on the fly when new incentive tokens are added

- cCrvToken
	- Minted 1:1 ratio for each crv deposited into the system

- ConvexToken
	- System native token
	- Minted at a defined ratio for each crv mined in the system
	- Mint ratio is reduced as supply increases


Contract Interaction Flow
--------
- LP Deposit
	- safe transfer lp tokens to deposit contract
	- add user balance
	- add user balance to pool's reward contracts
	- move tokens to proxy contract
	- deposit on curve gauge
	- stash rewards claimed during deposit to the pool's stash contract

- LP Withdrawal
	- Check current amount on deposit contract
	- unstake required amount from curve gauge
	- move tokens from proxy to deposit contract
	- stash rewards claimed during withdrawal to the pool's stash contract
	- claim pool rewards
	- remove user balance
	- remove user balance on pool's reward contract
	- send tokens to user

- Lock Crv
	- transfer crv to depositor
	- if lock==false
		- remove small fee from user amount
		- add fee to incentive reward for next user to call lock
	- if lock==true then call lock curve
		- get wallet checker from curve escro
		- check if proxy is whitelisted
		- if true
			- transfer crv to proxy
			- calculate max week to lock
			- get current vecrv
			- if no vecrv
				- release any old lock
				- create new lock
			- if vecrv
				- call increase amount
				- if last time increase was 2 or more weeks ago
					- call increase time
			- mint cCrv for lock incentive amount
			- reset lock incentive amount
	- mint cCrv equal to user amount

- Add Pool
	- get curve's registry
	- get lp token from swap address
	- get gauge from swap address
	- check if gauge passed as a parameter is in registry list
	- check if gauge has been added to convex before or not
	- create crv rewards contract for new pool
	- create stash contract for new pool
	- add pool to poolinfo array
	- set stash access on proxy and reward factory

- Earmark Rewards
	- claim crv off gauge and send to deposit contract
	- check if stash can claim extra rewards
	- if stash can claim
		- claim rewards to proxy
		- pull rewards from proxy to stash
		- move rewards to extra rewards contract
	- calculate crv ratios for cCrv, cvx, contract caller, treasury
	- transfer crv to caller
	- transfer to treasury
	- transfer to reward contract and queue new rewards
	- transfer to ccrv holder's reward contract and queue new rewards
	- transfer to cvx holder's reward contract and queue new rewards

- Earmark Fees
	- Tell proxy to claim vecrv fees
	- proxy sends fees to depositor
	- depositor sends to cCrv vecrv reward contract and queues new rewards


Keys (owner)
-------
- Needed for initial setup
- Burned once everything is in place and tested
- LP tokens are NEVER at risk

Keys (multisig)
--------------------
- feeManager
	- Set platform fees within hardcoded limits
	- Set vecrv fee rewards settings(in case dao changes from 3crv)
	- Set treasury address

- voteDelegate
	- Curve DAO voting.


Key Risk Mitigations
---
- Voting
	- No real risk

- Vecrv claim contract/token address change
	- Fee reward contracts can only be created via a factory so no malicious reward contract that syphons fees can be deployed.
	- If the curve registry supplies this info at a later date, can plug a module in to automatically grab from registry and remove necessity of a key.

- Fee changes
	- Allowable ranges are hard coded.

- Treasury address setting
	- fee range settings limit potential damage 
